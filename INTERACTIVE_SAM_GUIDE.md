# 🏢 Interactive SAM Mall Annotator 使用指南

## 🚀 项目概述

这是一个基于 Segment Anything Model (SAM) 的交互式商场地图标注工具，允许用户通过点击或框选的方式精确标注店铺边界，生成高质量的交互式地图数据。

## 🛠️ 功能特性

### ✨ 核心功能
- **🎯 交互式标注**: 点击模式和框选模式
- **🤖 SAM集成**: 真实的Segment Anything模型支持
- **🎨 实时预览**: 即时可视化标注结果
- **💾 数据导出**: JSON格式的结构化数据
- **📱 响应式设计**: 适配不同屏幕尺寸

### 🎮 标注模式

#### 1. 📍 点击模式
- **左键点击**: 添加正样本点（告诉SAM"我想要这个区域"）
- **右键点击**: 添加负样本点（告诉SAM"我不想要这个区域"）
- **适用场景**: 精确控制边界，处理复杂形状

#### 2. 📦 框选模式  
- **拖拽鼠标**: 框选目标区域
- **自动识别**: SAM自动识别框内的主要对象
- **适用场景**: 规则形状的快速标注

## 🚀 快速开始

### 1. 启动SAM API服务器

```bash
# 确保已安装依赖
pip install flask flask-cors segment_anything opencv-python numpy pillow

# 启动服务器
python sam_api_server.py
```

服务器将在 `http://localhost:5000` 启动

### 2. 打开标注界面

在浏览器中访问: `http://localhost:5000`

### 3. 开始标注

1. **选择标注模式** (点击/框选)
2. **在图像上标注** (添加点或拖拽框)
3. **生成SAM掩码** (点击"生成掩码"按钮)
4. **输入店铺信息** (名称和类别)
5. **保存标注** (点击"保存当前标注")
6. **重复上述步骤** 完成所有店铺
7. **导出数据** (点击"导出数据"按钮)

## 📋 详细操作流程

### Step 1: 模式选择
- 选择合适的标注模式
- 点击模式适合精细控制
- 框选模式适合快速标注

### Step 2: 交互标注

#### 点击模式操作:
```
左键 → 正样本点 (绿色) → "包含这个区域"
右键 → 负样本点 (红色) → "排除这个区域"
```

#### 框选模式操作:
```
按住左键 → 拖拽 → 释放 → 生成选择框
```

### Step 3: SAM掩码生成
- 点击"🔮 生成掩码"按钮
- SAM将处理您的输入并生成精确掩码
- 黄色高亮显示预测结果

### Step 4: 信息输入
```
店铺名称: 例如 "シルパイ シルスチュアート"
店铺类别: 选择对应类别
- レディスファッション (女装)
- インテリア・生活雑貨 (室内装饰)  
- ファッション雑貨 (时尚配件)
```

### Step 5: 保存和管理
- 保存当前标注
- 查看已标注店铺列表
- 清除错误标注
- 导出最终数据

## 🎯 最佳实践

### 💡 标注技巧

#### 点击模式技巧:
1. **起始点**: 在目标店铺中心点击
2. **边界点**: 在边界附近添加正样本点
3. **排除点**: 用负样本点排除不需要的区域
4. **迭代优化**: 多次添加点来精细调整

#### 框选模式技巧:
1. **紧贴边界**: 框选时尽量贴近店铺边界
2. **避免重叠**: 不要包含其他店铺区域
3. **完整覆盖**: 确保框选覆盖整个店铺

### 🎨 视觉指南

```
🟢 绿色圆点 = 正样本 ("要这个")
🔴 红色圆点 = 负样本 ("不要这个")  
🟡 黄色框线 = 选择框
🟡 黄色高亮 = SAM预测结果
🎨 彩色填充 = 已保存的标注
```

### ⚡ 效率提升

1. **批量标注**: 先标注所有简单形状，再处理复杂形状
2. **模式切换**: 根据店铺形状选择合适模式
3. **预览确认**: 生成掩码后仔细检查边界
4. **及时保存**: 每完成一个店铺立即保存

## 🔧 技术细节

### API接口

#### POST /api/init
初始化SAM模型
```json
{
  "image_path": "lumine-yurakucho.png"
}
```

#### POST /api/predict  
SAM掩码预测
```json
{
  "points": [[x1, y1], [x2, y2]],
  "point_labels": [1, 0],
  "boxes": [[x1, y1, x2, y2]]
}
```

#### GET /api/health
服务状态检查

### 数据格式

#### 输出JSON结构:
```json
{
  "image_dimensions": {"width": 610, "height": 929},
  "extraction_method": "web_interactive_sam_annotation",
  "categories": {...},
  "stores": [
    {
      "id": "store_0",
      "name": "シルパイ シルスチュアート",
      "category": "レディスファッション", 
      "color": "#FFB6C1",
      "bbox": {"x": 248, "y": 95, "width": 124, "height": 107},
      "polygon": [{"x": 248, "y": 95}, ...],
      "center": {"x": 310, "y": 148},
      "area": 13268
    }
  ]
}
```

## 🐛 故障排除

### 常见问题

#### 1. SAM服务无法启动
```bash
# 检查依赖
pip list | grep segment-anything

# 重新安装SAM
pip install git+https://github.com/facebookresearch/segment-anything.git

# 检查模型文件
ls -la sam_vit_b_01ec64.pth
```

#### 2. 掩码生成失败
- 确保至少添加一个正样本点
- 检查网络连接到SAM服务
- 查看浏览器开发者工具的错误信息

#### 3. 标注精度不够
- 增加更多正样本点
- 使用负样本点排除不需要的区域
- 尝试不同的点击位置

#### 4. 浏览器兼容性
- 推荐使用Chrome/Firefox最新版本
- 确保启用JavaScript
- 检查CORS设置

## 🎯 进阶用法

### 🔬 SAM参数调优

在`sam_api_server.py`中可以调整SAM参数:

```python
masks, scores, _ = self.predictor.predict(
    point_coords=input_points,
    point_labels=input_labels,
    box=input_boxes,
    multimask_output=True  # 生成多个候选掩码
)
```

### 🎨 自定义类别

修改`web_sam_annotator.js`中的类别定义:

```javascript
const categoryColors = {
    "レディスファッション": "#FFB6C1",
    "インテリア・生活雑貨": "#ADD8E6", 
    "ファッション雑貨": "#98FB98",
    "新类别": "#自定义颜色"
};
```

### 📊 批量处理

可以扩展系统支持多张图像的批量标注:

1. 修改API支持图像切换
2. 添加图像管理界面
3. 实现批量导出功能

## 📈 性能优化

### 🚀 加速技巧

1. **模型预热**: 启动时预加载SAM模型
2. **图像缓存**: 缓存处理后的图像数据
3. **异步处理**: 使用异步API调用
4. **内存管理**: 及时清理大型掩码数据

### 💾 存储优化

1. **增量保存**: 实时保存标注进度
2. **数据压缩**: 压缩导出的JSON数据
3. **本地存储**: 利用浏览器localStorage

## 🤝 贡献指南

欢迎提交改进建议和bug报告！

### 开发环境搭建

```bash
# 克隆项目
git clone <repository>

# 安装依赖
pip install -r requirements.txt

# 启动开发服务器
python sam_api_server.py
```

### 代码结构

```
├── sam_api_server.py          # Flask API服务器
├── web_sam_annotator.html     # 前端界面  
├── web_sam_annotator.js       # 前端逻辑
├── lumine-yurakucho.png       # 示例图像
└── output/                    # 输出目录
    └── web_sam_annotations.json
```

---

## 🎉 总结

这个交互式SAM标注工具为商场地图标注提供了强大而易用的解决方案。通过结合SAM的先进分割能力和直观的Web界面，用户可以高效地创建精确的店铺边界标注数据。

**关键优势:**
- ✅ **精确度高**: SAM模型保证分割质量
- ✅ **操作简单**: 直观的点击和框选交互
- ✅ **效率提升**: 相比手动标注大幅提速
- ✅ **数据标准**: 结构化的JSON输出格式
- ✅ **可扩展性**: 易于适配其他场景和需求

开始使用这个工具，让您的地图标注工作变得更加高效和精确！